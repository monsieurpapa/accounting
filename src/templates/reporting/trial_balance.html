{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Balance de Vérification" %} | Système de Comptabilité{% endblock %}

{% block page_title %}Balance de vérification{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'reporting:index' %}">Rapports</a></li>
<li class="breadcrumb-item active" aria-current="page">Balance de vérification</li>
{% endblock %}

{% block content %}
<div class="card mb-3">
    <div class="card-header bg-light">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">{% trans "Balance de vérification" %}</h5>
            </div>
            <div class="col-auto">
                <a href="{% url 'reporting:index' %}" class="btn btn-falcon-default btn-sm me-2">
                    <span class="fas fa-arrow-left me-1"></span>{% trans "Back" %}
                </a>
                <div class="dropdown font-sans-serif d-inline-block">
                    <button class="btn btn-falcon-default btn-sm dropdown-toggle" type="button" id="exportDropdown"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="fas fa-external-link-alt me-1"></span>{% trans "Exporter" %}
                    </button>
                    <div class="dropdown-menu dropdown-menu-end border py-0" aria-labelledby="exportDropdown">
                        <div class="bg-white py-2">
                            <a class="dropdown-item {% if not fiscal_year %}disabled{% endif %}" href="{% if fiscal_year %}{{ export_pdf_url }}{% else %}#{% endif %}"><span class="far fa-file-pdf me-2"></span>PDF</a>
                            <a class="dropdown-item {% if not fiscal_year %}disabled{% endif %}" href="{% if fiscal_year %}{{ export_excel_url }}{% else %}#{% endif %}"><span class="far fa-file-excel me-2"></span>Excel</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" onclick="window.print(); return false;"><span class="fas fa-print me-2"></span>{% trans "Imprimer" %}</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body border-top">
        <!-- Report Parameters -->
        <form method="get" action="{% url 'reporting:trial_balance' %}" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="fiscal_year" class="form-label fs--1">{% trans "Exercice fiscal" %}</label>
                    <select name="fiscal_year" id="fiscal_year" class="form-select form-select-sm shadow-none" required>
                        <option value="">-- {% trans "Sélectionner" %} --</option>
                        {% for fy in fiscal_years %}
                        <option value="{{ fy.pk }}" {% if fiscal_year and fy.pk == fiscal_year.pk %}selected{% endif %}>{{ fy.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="period" class="form-label fs--1">{% trans "Période" %}</label>
                    <select name="period" id="period" class="form-select form-select-sm shadow-none">
                        <option value="">{% trans "Toutes les périodes" %}</option>
                        {% for p in periods %}
                        <option value="{{ p.pk }}" {% if period and p.pk == period.pk %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-falcon-primary btn-sm w-100">
                        <span class="fas fa-filter me-1"></span>{% trans "Filtrer" %}
                    </button>
                </div>
            </div>
        </form>

        <div class="border rounded-3 p-4 bg-white shadow-sm mb-4">
            <div class="text-center mb-4">
                <h4 class="text-900 fw-bold">{% trans "Balance de vérification" %}</h4>
                <p class="mb-0 fs--1">{% trans "Période" %}: {% if period %}{{ period.name }}{% elif fiscal_year %}{{ fiscal_year.name }}{% else %}--{% endif %}</p>
            </div>

            <div class="table-responsive scrollbar">
                <table class="table table-bordered table-striped mb-0 fs--1">
                    <thead class="bg-200 text-900">
                        <tr>
                            <th rowspan="2" class="align-middle text-center">{% trans "Code" %}</th>
                            <th rowspan="2" class="align-middle">{% trans "Intitulé du compte" %}</th>
                            <th colspan="2" class="text-center border-bottom">{% trans "Soldes d'ouverture" %}</th>
                            <th colspan="2" class="text-center border-bottom">{% trans "Mouvements de la période" %}
                            </th>
                            <th colspan="2" class="text-center border-bottom">{% trans "Soldes de clôture" %}</th>
                        </tr>
                        <tr>
                            <th class="text-end border-start">{% trans "Débit" %}</th>
                            <th class="text-end">{% trans "Crédit" %}</th>
                            <th class="text-end border-start">{% trans "Débit" %}</th>
                            <th class="text-end">{% trans "Crédit" %}</th>
                            <th class="text-end border-start">{% trans "Débit" %}</th>
                            <th class="text-end">{% trans "Crédit" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in report_data %}
                        <tr>
                            <td class="text-center fw-semi-bold">{{ row.code }}</td>
                            <td>{{ row.name }}</td>
                            <td class="text-end">{{ row.opening_debit|floatformat:2 }}</td>
                            <td class="text-end">{{ row.opening_credit|floatformat:2 }}</td>
                            <td class="text-end">{{ row.period_debit|floatformat:2 }}</td>
                            <td class="text-end">{{ row.period_credit|floatformat:2 }}</td>
                            <td class="text-end fw-bold">{{ row.closing_debit|floatformat:2 }}</td>
                            <td class="text-end fw-bold">{{ row.closing_credit|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">{% trans "Aucune donnée disponible pour
                                cette période." %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-light fw-bold text-900">
                        <tr>
                            <td colspan="2" class="text-end text-uppercase">{% trans "Totaux" %}</td>
                            <td class="text-end">{{ grand_totals.opening_debit|floatformat:2 }}</td>
                            <td class="text-end">{{ grand_totals.opening_credit|floatformat:2 }}</td>
                            <td class="text-end">{{ grand_totals.period_debit|floatformat:2 }}</td>
                            <td class="text-end">{{ grand_totals.period_credit|floatformat:2 }}</td>
                            <td class="text-end text-primary">{{ grand_totals.closing_debit|floatformat:2 }}</td>
                            <td class="text-end text-primary">{{ grand_totals.closing_credit|floatformat:2 }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="row fs--1 text-700">
            <div class="col-md-6">
                <p class="mb-0"><strong>{% trans "Date de génération" %}:</strong> {{ generation_date|date:"d/m/Y" }}</p>
            </div>
            <div class="col-md-6 text-end">
                <p class="mb-0"><strong>{% trans "Généré par" %}:</strong> {{ request.user.get_full_name }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Reload periods when fiscal year changes
    document.getElementById('fiscal_year')?.addEventListener('change', function() {
        this.form.submit();
    });
</script>
{% endblock %}